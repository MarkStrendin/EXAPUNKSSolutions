; READ THE XMITTED #S
; WRITE THEM TO A FILE
; IF YOU GET -9999 THEN
; DROP THE FILE AND 
; SPAWN A VALIDATOR
MARK RESET
MAKE

MARK READLOOP
COPY M X

;SELF DESTRUCT CODE
TEST X = -7777
TJMP SELFDESTRUCT

;TEST FOR -9999'S
TEST X < -1
TJMP DIGITRESET

;COPY THE DIGIT
COPY X F
JUMP READLOOP

MARK DIGITRESET
FILE X
DROP
REPL ACCOUNTANT
JUMP RESET

MARK SELFDESTRUCT
FILE X
DROP
REPL ACCOUNTANT
HALT

MARK ACCOUNTANT
GRAB X
COPY 0 X

;DELETE EMPTY FILES
TEST EOF
TJMP FAIL

;VALIDATE LENGTH (16)

;VALIDATE NUMBER
MARK VALLENLOOP
COPY F T
ADDI 1 X X
TEST EOF
FJMP VALLENLOOP

;IF X IS'NT AT LEAST 16
;THEN DIE
TEST X > 15
FJMP FAIL

SEEK -9999
COPY 0 X

;NOW VALIDATE THE DIGITS
MARK VALDIGLOOP
;ADD THE ODD DIGIT *2
;WE CAN CHEAT AND 
;PREEMPTIVELY CHECK IF
;THE DIGIT*2 WILL BE >9
;AND JUST SUBTRACT 9
;IF IT WILL

@REP 8
TEST F > 4
FJMP NONINE@{0,1}
SUBI X 9 X
MARK NONINE@{0,1}
SEEK -1
MULI F 2 T
ADDI T X X

;IF WE'RE EOF HERE THEN
;WE DONT HAVE ENOUGH
;DIGITS TO FINISH
TEST EOF
TJMP FAIL 

;ADD THE EVEN DIGIT
ADDI F X X
@END

; CHECK X TO MAKE SURE
; ITS A POWER OF 10
MODI X 10 T
FJMP SUCCESS

;WE GOT THIS FAR BUT IT 
;DIDN'T WORK SO DELETE
;A DIGIT AND TRY AGAIN
SEEK -9999
VOID F
JUMP VALLENLOOP

MARK SUCCESS
;TRIM EXTRA DIGITS
SEEK -9999
SEEK 16

MARK DELETELOOP
VOID F
TEST EOF
FJMP DELETELOOP

; DROP THE FILE AND DIE
; THIS IS THE ONE
DROP
HALT

MARK FAIL
WIPE
HALT